<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gallery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        display: ["Space Grotesk", "sans-serif"],
                    },
                    colors: {
                        midnight: "#050b1a",
                        aurora: "#7cf5ff",
                        ember: "#FCB300",
                        slateglass: "rgba(15, 23, 42, 0.7)",
                    },
                    boxShadow: {
                        glow: "0 20px 60px rgba(8, 255, 214, 0.35)",
                    },
                },
            },
        };
    </script>
</head>

<body class="min-h-screen bg-black text-slate-100 font-display relative overflow-hidden">

    <header class="relative z-10 px-6 pt-8 lg:px-12">
        <div class="hidden pointer-events-none absolute inset-0">
            <div
                class="absolute -top-32 left-1/2 h-72 w-72 -translate-x-1/2 rounded-full bg-gradient-to-b from-aurora/50 to-aurora/80 blur-3xl opacity-70">
            </div>
        </div>
        <div class="mx-auto flex w-full max-w-6xl flex-col gap-8">
            <div class="flex flex-row items-center gap-4">
                <a href="{{ url_for('index') }}"
                    class="h-10 w-10 inline-flex items-center justify-center rounded-full border border-white/10 bg-white/5 text-sm font-medium text-white transition hover:border-white/30">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" class="h-5 w-5 translate-x-[3px]"
                        fill="#fff" aria-hidden="true">
                        <path
                            d="m142-480 294 294q15 15 14.5 35T435-116q-15 15-35 15t-35-15L57-423q-12-12-18-27t-6-30q0-15 6-30t18-27l308-308q15-15 35.5-14.5T436-844q15 15 15 35t-15 35L142-480Z" />
                    </svg>
                </a>
                <div>
                    <h1 class="text-4xl font-semibold leading-tight tracking-tight text-white">Gallery</h1>
                </div>

            </div>
        </div>
    </header>

    <main class="relative z-10 px-6 pb-16 pt-6 lg:px-12">
        <section class="mx-auto flex w-full max-w-6xl flex-col gap-8">
            {% if gallery_items %}
            <div class="grid gap-3 sm:grid-cols-2 xl:grid-cols-3">
                {% set day_scope = namespace(current_key=None) %}
                {% for item in gallery_items %}
                {% set item_day_key = item.day_key or (item.timestamp_iso.split('T')[0] if item.timestamp_iso else None)
                %}
                {% if item_day_key and item_day_key != day_scope.current_key %}
                <h3 class="col-span-full text-[0.8rem] mt-6 font-semibold uppercase tracking-[0.2em] text-white/80">
                    {{ item.day_label or item.timestamp_label|replace('\n', ' ') }}
                </h3>
                {% set day_scope.current_key = item_day_key %}
                {% endif %}
                <article class="rounded-2xl border border-white/10 bg-slateglass/80 backdrop-blur">
                    <div class="relative">
                        <button type="button" class="rounded-2xl group relative block w-full overflow-hidden" data-lightbox-trigger
                            data-lightbox-src="{{ url_for('serve_preview', filename=item.cover_path) }}"
                            data-lightbox-label="{{ item.timestamp_label|replace('\n', ' ') }}" data-lightbox-type="{{ item.type }}"
                            data-stack-id="{{ item.id }}"
                            data-stack-preview="{% if item.type in ['burst', 'timelapse'] %}{{ url_for('download_stack', capture_id=item.id, kind='preview') }}{% endif %}"
                            data-stack-raw="{% if item.type in ['burst', 'timelapse'] %}{{ url_for('download_stack', capture_id=item.id, kind='raw') }}{% endif %}"
                            data-lightbox-images='{{ item.images|tojson|safe }}'>
                            <div class="relative aspect-[4/3] overflow-hidden">
                                <img src="{{ url_for('serve_preview', filename=item.cover_path) }}"
                                    alt="Capture from {{ item.timestamp_label }}"
                                    class="h-full w-full object-cover transition duration-500 group-hover:scale-105 rounded-2xl" />
                                <div class="absolute inset-0 bg-gradient-to-t from-black/30 via-transparent to-transparent">
                                </div>
                                {% if item.type == 'burst' %}
                                <div
                                    class="absolute top-4 right-4 inline-flex items-center gap-1 rounded-full bg-black/60 px-3 py-1 text-xs font-medium text-white">
                                    <span class="text-base"><svg xmlns="http://www.w3.org/2000/svg" height="16px"
                                            viewBox="0 -960 960 960" width="16px" fill="#fff">
                                            <path
                                                d="M480-411q-10 0-19.5-2.5T442-421L104-605q-11-6-15.5-15T84-640q0-11 4.5-20t15.5-15l338-184q9-5 18.5-7.5T480-869q10 0 19.5 2.5T518-859l338 184q11 6 15.5 15t4.5 20q0 11-4.5 20T856-605L518-421q-9 5-18.5 7.5T480-411Zm0-80 273-149-273-149-273 149 273 149Zm0-149Zm0 309 314-171q2-1 19-5 17 0 28.5 11.5T853-467q0 11-5 20t-16 15L518-261q-9 5-18.5 7.5T480-251q-10 0-19.5-2.5T442-261L128-432q-11-6-16-15t-5-20q0-17 11.5-28.5T147-507q5 0 9.5 1.5t9.5 3.5l314 171Zm0 160 314-171q2-1 19-5 17 0 28.5 11.5T853-307q0 11-5 20t-16 15L518-101q-9 5-18.5 7.5T480-91q-10 0-19.5-2.5T442-101L128-272q-11-6-16-15t-5-20q0-17 11.5-28.5T147-347q5 0 9.5 1.5t9.5 3.5l314 171Z" />
                                        </svg></span>
                                    <span>{{ item.count }}</span>
                                </div>
                                {% elif item.type == 'timelapse' %}
                                <div
                                    class="absolute top-4 right-4 inline-flex items-center gap-1 rounded-full bg-black/60 px-3 py-1 text-xs font-medium text-white">
                                    <span class="text-base"><svg xmlns="http://www.w3.org/2000/svg" height="16px"
                                            viewBox="0 -960 960 960" width="16px" fill="#fff">
                                            <path
                                                d="M610-760q-21 0-35.5-14.5T560-810q0-21 14.5-35.5T610-860q21 0 35.5 14.5T660-810q0 21-14.5 35.5T610-760Zm0 660q-21 0-35.5-14.5T560-150q0-21 14.5-35.5T610-200q21 0 35.5 14.5T660-150q0 21-14.5 35.5T610-100Zm160-520q-21 0-35.5-14.5T720-670q0-21 14.5-35.5T770-720q21 0 35.5 14.5T820-670q0 21-14.5 35.5T770-620Zm0 380q-21 0-35.5-14.5T720-290q0-21 14.5-35.5T770-340q21 0 35.5 14.5T820-290q0 21-14.5 35.5T770-240Zm60-190q-21 0-35.5-14.5T780-480q0-21 14.5-35.5T830-530q21 0 35.5 14.5T880-480q0 21-14.5 35.5T830-430ZM80-480q0-157 104.5-270T441-878q16-2 27.5 9.5T480-840q0 16-10.5 28T443-798q-121 14-202 104t-81 214q0 125 81 214.5T443-162q16 2 26.5 14t10.5 28q0 17-11.5 28.5T441-82Q288-97 184-210T80-480Zm400 80q-33 0-56.5-23.5T400-480q0-5 .5-10.5T403-501l-55-55q-11-11-11-28t11-28q11-11 28-11t28 11l55 55q4-1 21-3 33 0 56.5 23.5T560-480q0 33-23.5 56.5T480-400Z" />
                                        </svg></span>
                                    <span>{{ item.count }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </button>
                    </div>
                
                </article>
                {% endfor %}
                </div>
                {% else %}
                <div class="min-h-[60vh] flex flex-col items-center justify-center text-center">
                    <p class="my-2 text-2xl font-semibold text-slate-200">Nothing here yet</p>
                    <p class="text-lg font-semibold text-slate-500">Connect your camera to get started</p>
                
                </div>
                {% endif %}
                </section>
                </main>
                
                <div id="lightbox" class="fixed inset-0 z-50 hidden flex flex-col bg-black">
                    <div class="absolute left-0 right-0 top-5 grid grid-cols-3 w-full items-center gap-4 px-5">
                        <button type="button" id="lightbox-close"
                            class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/10 bg-white/5 text-sm font-medium text-white transition hover:border-white/30"
                            aria-label="Close preview">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" class="h-5 w-5 translate-x-[3px]"
                                fill="#fff" aria-hidden="true">
                                <path
                                    d="m142-480 294 294q15 15 14.5 35T435-116q-15 15-35 15t-35-15L57-423q-12-12-18-27t-6-30q0-15 6-30t18-27l308-308q15-15 35.5-14.5T436-844q15 15 15 35t-15 35L142-480Z" />
                            </svg>
                        </button>
                        <p id="lightbox-caption" class="flex-1 text-center text-sm text-slate-300"></p>
                        <button type="button" id="more-options"
                            class="justify-self-end inline-flex h-10 w-10 items-center justify-center rounded-full border border-white/10 bg-white/5 text-sm font-medium text-white transition hover:border-white/30"
                            aria-label="Options">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fff">
                                <path
                                    d="M240-400q-33 0-56.5-23.5T160-480q0-33 23.5-56.5T240-560q33 0 56.5 23.5T320-480q0 33-23.5 56.5T240-400Zm240 0q-33 0-56.5-23.5T400-480q0-33 23.5-56.5T480-560q33 0 56.5 23.5T560-480q0 33-23.5 56.5T480-400Zm240 0q-33 0-56.5-23.5T640-480q0-33 23.5-56.5T720-560q33 0 56.5 23.5T800-480q0 33-23.5 56.5T720-400Z" />
                            </svg>
                        </button>
                    </div>
                    <div id="lightbox-options-menu"
                        class="absolute right-5 top-20 z-[60] hidden w-64 rounded-2xl bg-slate-900/90 p-1 shadow-[0_20px_45px_rgba(7,16,45,0.65)] backdrop-blur">
                        <div class="flex flex-col gap-3">
                            <div class="flex flex-col gap-2">
                                <p class="px-2 pt-2 text-xs font-medium text-slate-400">This frame only</p>
                                <button type="button" id="download-preview"
                                    class="w-full rounded-xl px-2 py-2 text-left text-xs font-medium text-white transition hover:bg-white/5 focus:outline-none focus:ring-2 focus:ring-aurora/50 disabled:cursor-not-allowed disabled:opacity-40">
                                    Download Preview
                                </button>
                                <button type="button" id="download-raw"
                                    class="w-full rounded-xl px-2 py-2 text-left text-xs font-medium text-white transition hover:bg-white/5 focus:outline-none focus:ring-2 focus:ring-ember/40 disabled:cursor-not-allowed disabled:opacity-40">
                                    Download RAW
                                </button>
                                <p id="raw-unavailable-hint" class="px-4 text-xs text-amber-300/80 hidden">RAW unavailable for this
                                    frame</p>
                            </div>
                            <div id="stack-download-divider" class="mx-2 h-px bg-white/10 hidden"></div>
                            <div id="stack-download-group" class="flex flex-col gap-2 hidden">
                                <p class="px-2 text-xs font-medium text-slate-400">All frames (.zip)</p>
                                <button type="button" id="download-preview-zip"
                                    class="w-full rounded-xl px-2 py-2 text-left text-xs font-medium text-white transition hover:bg-white/5 focus:outline-none focus:ring-2 focus:ring-aurora/40 disabled:cursor-not-allowed disabled:opacity-40">
                                    Download Previews
                                </button>
                                <button type="button" id="download-raw-zip"
                                    class="w-full rounded-xl px-2 py-2 text-left text-xs font-medium text-white transition hover:bg-white/5 focus:outline-none focus:ring-2 focus:ring-ember/40 disabled:cursor-not-allowed disabled:opacity-40">
                                    Download RAW
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-1 items-center justify-center">
                        <img id="lightbox-image" src="" class="max-h-[80vh] w-full object-contain" />
                    </div>
                    <div id="lightbox-carousel" class="hidden px-6 py-6">
                        <div
                            class="mx-auto flex w-full max-w-5xl items-center justify-between text-[0.65rem] font-semibold uppercase tracking-[0.35em] text-slate-400">
                            <span>Frames</span>
                            <span id="lightbox-frame-counter" class="tracking-normal text-slate-300"></span>
                        </div>
                        <div id="lightbox-carousel-track" class="mx-auto mt-4 flex w-full max-w-5xl gap-3 overflow-x-auto pb-2">
                        </div>
                    </div>
                </div>

    <script>
        const previewBaseUrl = ("{{ url_for('serve_preview', filename='') }}".trim() || "/previews/").replace(/\/+$/, "/");
        const rawBaseUrl = ("{{ url_for('serve_raw', filename='') }}".trim() || "/raw/").replace(/\/+$/, "/");
            const STACKABLE_TYPES = new Set(["burst", "timelapse"]);

            const lightbox = document.getElementById("lightbox");
            const lightboxImage = document.getElementById("lightbox-image");
            const lightboxCaption = document.getElementById("lightbox-caption");
            const closeLightboxButton = document.getElementById("lightbox-close");
            const lightboxCarousel = document.getElementById("lightbox-carousel");
            const lightboxCarouselTrack = document.getElementById("lightbox-carousel-track");
            const lightboxFrameCounter = document.getElementById("lightbox-frame-counter");
            const moreOptionsButton = document.getElementById("more-options");
            const optionsMenu = document.getElementById("lightbox-options-menu");
            const downloadPreviewButton = document.getElementById("download-preview");
            const downloadRawButton = document.getElementById("download-raw");
            const downloadPreviewZipButton = document.getElementById("download-preview-zip");
            const downloadRawZipButton = document.getElementById("download-raw-zip");
            const rawUnavailableHint = document.getElementById("raw-unavailable-hint");
            const stackDownloadGroup = document.getElementById("stack-download-group");
            const stackDownloadDivider = document.getElementById("stack-download-divider");

            let currentLightboxImages = [];
            let currentLightboxIndex = 0;
            let currentLightboxStack = {
                type: null,
                captureId: null,
            previewZipUrl: "",
            rawZipUrl: "",
        };

            function normalizeLabel(label) {
                return (label || "").replace(/\s+/g, " ").trim();
            }

            function resolvePreviewSrc(candidate) {
                if (!candidate) {
                    return "";
                }
                if (/^https?:\/\//i.test(candidate) || candidate.startsWith("/")) {
                    return candidate;
                }
            return `${previewBaseUrl}${candidate}`.replace(/([^:]\/)\+/g, "$1");
        }

            function prepareImages(rawImages, baseLabel) {
                if (!Array.isArray(rawImages)) {
                    return [];
                }
                return rawImages
                    .map((raw) => {
                        const previewPath = raw && raw.path ? raw.path : null;
                        const candidateSource = raw && (raw.src || previewPath);
                        const src = resolvePreviewSrc(candidateSource);
                        if (!src) {
                            return null;
                        }
                    return {
                        src,
                        label: baseLabel,
                        filename: raw && raw.filename ? raw.filename : null,
                        path: previewPath,
                        rawPath: raw && raw.raw_path ? raw.raw_path : null,
                    };
                })
                .filter(Boolean);
        }

            function updateLightboxImage(index) {
                if (!currentLightboxImages.length) {
                    return;
                }
                const clampedIndex = Math.max(0, Math.min(index, currentLightboxImages.length - 1));
                const frame = currentLightboxImages[clampedIndex];
                currentLightboxIndex = clampedIndex;
                lightboxImage.src = frame.src;
                lightboxImage.alt = frame.label || "Captured frame";
                lightboxCaption.textContent = frame.label || "";
                updateDownloadControls();
            }

            function buildPreviewDownloadUrl(frame) {
                if (!frame) {
                    return null;
                }
                if (frame.path) {
                    return resolvePreviewSrc(frame.path);
                }
                return frame.src || null;
            }

            function buildRawDownloadUrl(frame) {
                if (!frame || !frame.rawPath) {
                    return null;
                }
                return `${rawBaseUrl}${frame.rawPath}`;
            }

            function triggerDownload(url, filename) {
                if (!url) {
                    return;
                }
                const anchor = document.createElement("a");
                anchor.href = url;
                if (filename) {
                    anchor.download = filename;
                }
                anchor.rel = "noopener";
                document.body.appendChild(anchor);
                anchor.click();
                document.body.removeChild(anchor);
            }

            function isStackedSelection() {
            return STACKABLE_TYPES.has((currentLightboxStack.type || "").toLowerCase());
        }

            function updateDownloadControls() {
                const frame = currentLightboxImages[currentLightboxIndex];
                const previewUrl = buildPreviewDownloadUrl(frame);
                const rawUrl = buildRawDownloadUrl(frame);

            if (downloadPreviewButton) {
                downloadPreviewButton.disabled = !previewUrl;
            }
            if (downloadRawButton) {
                downloadRawButton.disabled = !rawUrl;
            }
            if (rawUnavailableHint) {
                rawUnavailableHint.classList.toggle("hidden", Boolean(rawUrl));
            }

            const stacked = isStackedSelection();
            if (stackDownloadGroup) {
                stackDownloadGroup.classList.toggle("hidden", !stacked);
                stackDownloadDivider.classList.toggle("hidden", !stacked);
            }
            if (downloadPreviewZipButton) {
                downloadPreviewZipButton.classList.toggle("hidden", !stacked);
                downloadPreviewZipButton.disabled = !stacked || !currentLightboxStack.previewZipUrl;
            }
            if (downloadRawZipButton) {
                downloadRawZipButton.classList.toggle("hidden", !stacked);
                downloadRawZipButton.disabled = !stacked || !currentLightboxStack.rawZipUrl;
            }
        }

            function downloadCurrentFrameAsset(kind) {
                if (kind === "preview-zip" || kind === "raw-zip") {
                const targetUrl = kind === "preview-zip"
                    ? currentLightboxStack.previewZipUrl
                    : currentLightboxStack.rawZipUrl;
                if (!targetUrl) {
                    updateDownloadControls();
                    return;
                }
                const suffix = kind === "preview-zip" ? "previews" : "raw";
                const fallback = currentLightboxStack.captureId
                    ? `${currentLightboxStack.captureId}-${suffix}.zip`
                    : `capture-${suffix}.zip`;
                triggerDownload(targetUrl, fallback);
                hideOptionsMenu();
                return;
            }

            if (!currentLightboxImages.length) {
                return;
            }
            const frame = currentLightboxImages[currentLightboxIndex];
            if (!frame) {
                return;
            }
            if (kind === "preview") {
                const previewUrl = buildPreviewDownloadUrl(frame);
                if (!previewUrl) {
                    return;
                }
                const fallbackName = frame.filename || "capture-preview.jpg";
                triggerDownload(previewUrl, fallbackName);
                hideOptionsMenu();
                return;
            }
            const rawUrl = buildRawDownloadUrl(frame);
            if (!rawUrl) {
                updateDownloadControls();
                return;
            }
            const rawName = frame.rawPath
                ? frame.rawPath.split("/").pop()
                : (frame.filename || "").replace(/\.[^.]+$/, ".nef");
            triggerDownload(rawUrl, rawName || "capture-raw.nef");
            hideOptionsMenu();
        }

            function hideOptionsMenu() {
                if (!optionsMenu) {
                    return;
                }
                optionsMenu.classList.add("hidden");
            }

            function renderLightboxCarousel() {
                if (!currentLightboxImages.length || currentLightboxImages.length === 1) {
                    lightboxCarousel.classList.add("hidden");
                    lightboxImage.classList.remove("mt-16");
                    lightboxCarouselTrack.innerHTML = "";
                    lightboxFrameCounter.textContent = "";
                    return;
                }

            lightboxCarousel.classList.remove("hidden");
            lightboxImage.classList.add("mt-16");
            lightboxCarouselTrack.innerHTML = "";
            lightboxFrameCounter.textContent = `${currentLightboxIndex + 1} / ${currentLightboxImages.length}`;

            currentLightboxImages.forEach((image, index) => {
                const thumbButton = document.createElement("button");
                thumbButton.type = "button";
                thumbButton.className = `relative h-20 w-28 flex-shrink-0 overflow-hidden rounded-xl border transition focus:outline-none ${index === currentLightboxIndex
                    ? "border-aurora shadow-glow"
                    : "border-white/10 hover:border-white/30"}`;
                thumbButton.setAttribute("aria-label", image.label || `Frame ${index + 1}`);

                const thumbImage = document.createElement("img");
                thumbImage.src = image.src;
                thumbImage.alt = image.label || `Frame ${index + 1}`;
                thumbImage.className = "h-full w-full object-cover";
                thumbButton.appendChild(thumbImage);

                if (index === currentLightboxIndex) {
                    const indicator = document.createElement("div");
                    indicator.className = "pointer-events-none absolute inset-0 bg-aurora/10 ring-1 ring-inset ring-aurora/30";
                    thumbButton.appendChild(indicator);
                }

                thumbButton.addEventListener("click", () => {
                    updateLightboxImage(index);
                    renderLightboxCarousel();
                });

                lightboxCarouselTrack.appendChild(thumbButton);
            });
        }

            function openLightbox(src, label, rawImages = [], startingIndex = 0, stackMeta = {}) {
                const normalizedLabel = normalizeLabel(label);
                let preparedImages = prepareImages(rawImages, normalizedLabel);
                if (!preparedImages.length && src) {
                    preparedImages = [{ src, label: normalizedLabel }];
                }
                currentLightboxImages = preparedImages;
                currentLightboxStack = {
                    type: stackMeta.type || null,
                    captureId: stackMeta.captureId || null,
                    previewZipUrl: stackMeta.previewZipUrl || "",
                    rawZipUrl: stackMeta.rawZipUrl || "",
                };
                if (!currentLightboxImages.length) {
                    return;
                }
                const initialIndex = Number.isNaN(startingIndex)
                    ? 0
                    : Math.max(0, Math.min(startingIndex, currentLightboxImages.length - 1));
                updateLightboxImage(initialIndex);
                renderLightboxCarousel();
                lightbox.classList.remove("hidden");
                document.body.classList.add("overflow-hidden");
            }

            function closeLightbox() {
                lightbox.classList.add("hidden");
                lightboxImage.src = "";
                document.body.classList.remove("overflow-hidden");
                lightboxCaption.textContent = "";
                currentLightboxImages = [];
                currentLightboxIndex = 0;
                currentLightboxStack = {
                    type: null,
                    captureId: null,
                previewZipUrl: "",
                rawZipUrl: "",
            };
            lightboxCarouselTrack.innerHTML = "";
            lightboxCarousel.classList.add("hidden");
            lightboxFrameCounter.textContent = "";
            hideOptionsMenu();
        }

            document.querySelectorAll("[data-lightbox-trigger]").forEach((trigger) => {
                trigger.addEventListener("click", () => {
                    const src = trigger.getAttribute("data-lightbox-src");
                    const label = trigger.getAttribute("data-lightbox-label") || "";
                    const imagesAttr = trigger.getAttribute("data-lightbox-images");
                    let parsedImages = [];
                    if (imagesAttr) {
                        try {
                            parsedImages = JSON.parse(imagesAttr);
                        } catch (error) {
                            console.warn("Unable to parse image payload for lightbox", error);
                        }
                    }
                    const startingIndexAttr = trigger.getAttribute("data-lightbox-index");
                    const startingIndex = startingIndexAttr ? Number.parseInt(startingIndexAttr, 10) : 0;
                    const stackMeta = {
                        type: trigger.getAttribute("data-lightbox-type") || "",
                        captureId: trigger.getAttribute("data-stack-id") || "",
                        previewZipUrl: trigger.getAttribute("data-stack-preview") || "",
                        rawZipUrl: trigger.getAttribute("data-stack-raw") || "",
                    };
                    openLightbox(
                        src,
                        label,
                        parsedImages,
                        Number.isNaN(startingIndex) ? 0 : startingIndex,
                        stackMeta,
                    );
                });
            });

            if (closeLightboxButton) {
                closeLightboxButton.addEventListener("click", closeLightbox);
            }
            if (moreOptionsButton) {
                moreOptionsButton.addEventListener("click", () => {
                    if (!currentLightboxImages.length) {
                        return;
                    }
                    updateDownloadControls();
                if (optionsMenu) {
                    optionsMenu.classList.toggle("hidden");
                }
            });
                    }
                    if (downloadPreviewButton) {
                        downloadPreviewButton.addEventListener("click", () => downloadCurrentFrameAsset("preview"));
                    }
                    if (downloadRawButton) {
                        downloadRawButton.addEventListener("click", () => downloadCurrentFrameAsset("raw"));
                    }
                    if (downloadPreviewZipButton) {
                        downloadPreviewZipButton.addEventListener("click", () => downloadCurrentFrameAsset("preview-zip"));
                    }
                    if (downloadRawZipButton) {
                        downloadRawZipButton.addEventListener("click", () => downloadCurrentFrameAsset("raw-zip"));
                    }
                    if (lightbox) {
                        lightbox.addEventListener("click", (event) => {
                            if (event.target === lightbox) {
                                closeLightbox();
                            }
                        });
                    }
                    document.addEventListener("click", (event) => {
                        if (!optionsMenu || optionsMenu.classList.contains("hidden")) {
                            return;
                        }
                        if (optionsMenu.contains(event.target) || (moreOptionsButton && moreOptionsButton.contains(event.target))) {
                            return;
                        }
                        hideOptionsMenu();
                    });
                    document.addEventListener("keydown", (event) => {
                        if (event.key !== "Escape") {
                            return;
                        }
                        if (optionsMenu && !optionsMenu.classList.contains("hidden")) {
                            hideOptionsMenu();
                            return;
            }
            if (!lightbox.classList.contains("hidden")) {
                closeLightbox();
            }
        });
        closeLightbox();
    </script>
</body>

</html>
