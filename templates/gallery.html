<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gallery</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        display: ["Space Grotesk", "sans-serif"],
                    },
                    colors: {
                        midnight: "#050b1a",
                        aurora: "#7cf5ff",
                        ember: "#FCB300",
                        slateglass: "rgba(15, 23, 42, 0.7)",
                    },
                    boxShadow: {
                        glow: "0 20px 60px rgba(8, 255, 214, 0.35)",
                    },
                },
            },
        };
    </script>
</head>

<body class="min-h-screen bg-black text-slate-100 font-display relative overflow-hidden">

    <header class="relative z-10 px-6 pt-8 lg:px-12">
        <div class="hidden pointer-events-none absolute inset-0">
            <div
                class="absolute -top-32 left-1/2 h-72 w-72 -translate-x-1/2 rounded-full bg-gradient-to-b from-aurora/50 to-aurora/80 blur-3xl opacity-70">
            </div>
        </div>
        <div class="mx-auto flex w-full max-w-6xl flex-col gap-8">
            <div class="flex flex-row items-center gap-4">
                <a href="{{ url_for('index') }}"
                    class="h-10 w-10 inline-flex items-center justify-center rounded-full border border-white/10 bg-white/5 text-sm font-medium text-white transition hover:border-white/30">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" class="h-5 w-5 translate-x-[3px]"
                        fill="#fff" aria-hidden="true">
                        <path
                            d="m142-480 294 294q15 15 14.5 35T435-116q-15 15-35 15t-35-15L57-423q-12-12-18-27t-6-30q0-15 6-30t18-27l308-308q15-15 35.5-14.5T436-844q15 15 15 35t-15 35L142-480Z" />
                    </svg>
                </a>
                <div>
                    <h1 class="text-4xl font-semibold leading-tight tracking-tight text-white">Gallery</h1>
                </div>

            </div>
        </div>
    </header>

    <main class="relative z-10 px-6 pb-16 pt-6 lg:px-12">
        <section class="mx-auto flex w-full max-w-6xl flex-col gap-8">
            {% if gallery_items %}
            <div class="grid gap-3 sm:grid-cols-2 xl:grid-cols-3">
                {% set day_scope = namespace(current_key=None) %}
                {% for item in gallery_items %}
                <script>
                    const previewBaseUrl = ("{{ url_for('serve_preview', filename='') }}".trim() || "/previews/").replace(/\/+$/, "/");
                        const rawBaseUrl = ("{{ url_for('serve_raw', filename='') }}".trim() || "/raw/").replace(/\/+$/, "/");
                        const stackableTypes = new Set(["burst", "timelapse"]);

                        const lightbox = document.getElementById("lightbox");
                        const lightboxImage = document.getElementById("lightbox-image");
                        const lightboxCaption = document.getElementById("lightbox-caption");
                        const closeLightboxButton = document.getElementById("lightbox-close");
                        const lightboxCarousel = document.getElementById("lightbox-carousel");
                        const lightboxCarouselTrack = document.getElementById("lightbox-carousel-track");
                        const lightboxFrameCounter = document.getElementById("lightbox-frame-counter");
                        const moreOptionsButton = document.getElementById("more-options");
                        const optionsMenu = document.getElementById("lightbox-options-menu");
                        const downloadPreviewButton = document.getElementById("download-preview");
                        const downloadRawButton = document.getElementById("download-raw");
                        const downloadPreviewZipButton = document.getElementById("download-preview-zip");
                        const downloadRawZipButton = document.getElementById("download-raw-zip");
                        const rawUnavailableHint = document.getElementById("raw-unavailable-hint");
                        const stackDownloadGroup = document.getElementById("stack-download-group");

                        let currentLightboxImages = [];
                        let currentLightboxIndex = 0;
                        let currentLightboxStack = {
                            type: null,
                            captureId: null,
                            previewZipUrl: null,
                            rawZipUrl: null,
                        };

                        function normalizeLabel(label) {
                            return (label || "").replace(/\s+/g, " ").trim();
                        }

                        function resolvePreviewSrc(candidate) {
                            if (!candidate) {
                                return "";
                            }
                            if (/^https?:\/\//i.test(candidate) || candidate.startsWith("/")) {
                                return candidate;
                            }
                        return `${previewBaseUrl}${candidate}`.replace(/([^:]\/)8+/g, "$1");
                    }

                        function prepareImages(rawImages, baseLabel) {
                            if (!Array.isArray(rawImages)) {
                                return [];
                            }
                            return rawImages
                            .map((raw) => {
                                const previewPath = raw && raw.path ? raw.path : null;
                                const candidateSource = raw && (raw.src || previewPath);
                                const src = resolvePreviewSrc(candidateSource);
                                if (!src) {
                                    return null;
                                }
                                const frameLabel = rawImages.length > 1 && baseLabel ? `${baseLabel}` : baseLabel;
                                return {
                                    src,
                                    label: frameLabel,
                                    filename: raw && raw.filename ? raw.filename : null,
                                    path: previewPath,
                                    rawPath: raw && raw.raw_path ? raw.raw_path : null,
                                };
                            })
                            .filter(Boolean);
                    }

                        function updateLightboxImage(index) {
                            if (!currentLightboxImages.length) {
                                return;
                            }
                            const clampedIndex = Math.max(0, Math.min(index, currentLightboxImages.length - 1));
                            const frame = currentLightboxImages[clampedIndex];
                            currentLightboxIndex = clampedIndex;
                            lightboxImage.src = frame.src;
                            lightboxImage.alt = frame.label || "Captured frame";
                            lightboxCaption.textContent = frame.label || "";
                                updateDownloadControls();
                            }

                            function buildPreviewDownloadUrl(frame) {
                                if (!frame) {
                                    return null;
                                }
                                if (frame.path) {
                                    return resolvePreviewSrc(frame.path);
                                }
                                return frame.src || null;
                            }

                            function buildRawDownloadUrl(frame) {
                                if (!frame || !frame.rawPath) {
                                    return null;
                                }
                                return `${rawBaseUrl}${frame.rawPath}`;
                            }

                            function triggerDownload(url, filename) {
                                if (!url) {
                                    return;
                                }
                                const anchor = document.createElement("a");
                                anchor.href = url;
                                if (filename) {
                                    anchor.download = filename;
                                }
                                anchor.rel = "noopener";
                                document.body.appendChild(anchor);
                                anchor.click();
                                document.body.removeChild(anchor);
                            }

                            function isStackedSelection() {
                                return stackableTypes.has((currentLightboxStack.type || "").toLowerCase());
                            }

                            function updateDownloadControls() {
                                const frame = currentLightboxImages[currentLightboxIndex];
                                const previewUrl = buildPreviewDownloadUrl(frame);
                                const rawUrl = buildRawDownloadUrl(frame);

                                if (downloadPreviewButton) {
                                    downloadPreviewButton.disabled = !previewUrl;
                                }
                                if (downloadRawButton) {
                                    downloadRawButton.disabled = !rawUrl;
                                }
                                if (rawUnavailableHint) {
                                    rawUnavailableHint.classList.toggle("hidden", Boolean(rawUrl));
                                }

                                const stacked = isStackedSelection();
                                if (stackDownloadGroup) {
                                    stackDownloadGroup.classList.toggle("hidden", !stacked);
                                }
                                if (downloadPreviewZipButton) {
                                    downloadPreviewZipButton.classList.toggle("hidden", !stacked);
                                    downloadPreviewZipButton.disabled = !stacked || !currentLightboxStack.previewZipUrl;
                                }
                                if (downloadRawZipButton) {
                                    downloadRawZipButton.classList.toggle("hidden", !stacked);
                                    downloadRawZipButton.disabled = !stacked || !currentLightboxStack.rawZipUrl;
                                }
                            }

                            function downloadCurrentFrameAsset(kind) {
                                if (kind === "preview-zip" || kind === "raw-zip") {
                                    const targetUrl = kind === "preview-zip" ? currentLightboxStack.previewZipUrl : currentLightboxStack.rawZipUrl;
                                    if (!targetUrl) {
                                        updateDownloadControls();
                                        return;
                                    }
                                    const suffix = kind === "preview-zip" ? "previews" : "raw";
                                    const fallback = currentLightboxStack.captureId ? `${currentLightboxStack.captureId}-${suffix}.zip` : `capture-${suffix}.zip`;
                                    triggerDownload(targetUrl, fallback);
                                    hideOptionsMenu();
                                    return;
                                }

                                if (!currentLightboxImages.length) {
                                    return;
                                }
                                const frame = currentLightboxImages[currentLightboxIndex];
                                if (!frame) {
                                    return;
                                }
                                if (kind === "preview") {
                                    const previewUrl = buildPreviewDownloadUrl(frame);
                                    if (!previewUrl) {
                                        return;
                                    }
                                    const fallbackName = frame.filename || "capture-preview.jpg";
                                    triggerDownload(previewUrl, fallbackName);
                                    hideOptionsMenu();
                                    return;
                                }
                                const rawUrl = buildRawDownloadUrl(frame);
                                if (!rawUrl) {
                                    updateDownloadControls();
                                    return;
                                }
                                const rawName = frame.rawPath
                                    ? frame.rawPath.split("/").pop()
                                    : (frame.filename || "").replace(/\.[^.]+$/, ".nef");
                                triggerDownload(rawUrl, rawName || "capture-raw.nef");
                                hideOptionsMenu();
                            }

                            function hideOptionsMenu() {
                                if (!optionsMenu) {
                                    return;
                                }
                                optionsMenu.classList.add("hidden");
                    }

                        function renderLightboxCarousel() {
                            if (!currentLightboxImages.length || currentLightboxImages.length === 1) {
                                lightboxCarousel.classList.add("hidden");
                                        lightboxImage.classList.remove("mt-16");
                                        lightboxCarouselTrack.innerHTML = "";
                                        lightboxFrameCounter.textContent = "";
                                        return;
                                    }

                                    lightboxCarousel.classList.remove("hidden");
                                    lightboxImage.classList.add("mt-16");
                                    lightboxCarouselTrack.innerHTML = "";
                                    lightboxFrameCounter.textContent = `${currentLightboxIndex + 1} / ${currentLightboxImages.length}`;

                                    currentLightboxImages.forEach((image, index) => {
                                        const thumbButton = document.createElement("button");
                                        thumbButton.type = "button";
                                        thumbButton.className = `relative h-20 w-28 flex-shrink-0 overflow-hidden rounded-xl border transition focus:outline-none ${index === currentLightboxIndex
                                            ? "border-aurora shadow-glow"
                                            : "border-white/10 hover:border-white/30"}`;
                                        thumbButton.setAttribute("aria-label", image.label || `Frame ${index + 1}`);

                                        const thumbImage = document.createElement("img");
                                        thumbImage.src = image.src;
                                        thumbImage.alt = image.label || `Frame ${index + 1}`;
                                        thumbImage.className = "h-full w-full object-cover";
                                        thumbButton.appendChild(thumbImage);

                                        if (index === currentLightboxIndex) {
                                            const indicator = document.createElement("div");
                                            indicator.className = "pointer-events-none absolute inset-0 bg-aurora/10 ring-1 ring-inset ring-aurora/30";
                                            thumbButton.appendChild(indicator);
                                        }

                                        thumbButton.addEventListener("click", () => {
                                            updateLightboxImage(index);
                                            renderLightboxCarousel();
                                        });

                                        lightboxCarouselTrack.appendChild(thumbButton);
                                    });
                                }

                                function openLightbox(src, label, rawImages = [], startingIndex = 0, stackMeta = {}) {
                                    const normalizedLabel = normalizeLabel(label);
                                    let preparedImages = prepareImages(rawImages, normalizedLabel);
                                    if (!preparedImages.length && src) {
                                        preparedImages = [{ src, label: normalizedLabel }];
                                    }
                                    currentLightboxImages = preparedImages;
                                    currentLightboxStack = {
                                        type: stackMeta.type || null,
                                        captureId: stackMeta.captureId || null,
                                        previewZipUrl: stackMeta.previewZipUrl || "",
                                        rawZipUrl: stackMeta.rawZipUrl || "",
                                    };
                                    if (!currentLightboxImages.length) {
                                        return;
                                    }
                                    const initialIndex = Number.isNaN(startingIndex)
                                        ? 0
                                        : Math.max(0, Math.min(startingIndex, currentLightboxImages.length - 1));
                                    updateLightboxImage(initialIndex);
                                    renderLightboxCarousel();
                                    lightbox.classList.remove("hidden");
                                    document.body.classList.add("overflow-hidden");
                                }

                                function closeLightbox() {
                                    lightbox.classList.add("hidden");
                                    lightboxImage.src = "";
                                    document.body.classList.remove("overflow-hidden");
                                    lightboxCaption.textContent = "";
                                    currentLightboxImages = [];
                                    currentLightboxIndex = 0;
                                    currentLightboxStack = {
                                        type: null,
                                        captureId: null,
                                        previewZipUrl: null,
                                        rawZipUrl: null,
                                    };
                                    lightboxCarouselTrack.innerHTML = "";
                                    lightboxCarousel.classList.add("hidden");
                                    lightboxFrameCounter.textContent = "";
                                    hideOptionsMenu();
                                }

                                document.querySelectorAll("[data-lightbox-trigger]").forEach((trigger) => {
                                    trigger.addEventListener("click", () => {
                                        const src = trigger.getAttribute("data-lightbox-src");
                                        const label = trigger.getAttribute("data-lightbox-label") || "";
                                        const imagesAttr = trigger.getAttribute("data-lightbox-images");
                                        let parsedImages = [];
                                        if (imagesAttr) {
                                            try {
                                                parsedImages = JSON.parse(imagesAttr);
                                            } catch (error) {
                                                console.warn("Unable to parse image payload for lightbox", error);
                                            }
                                        }
                                        const startingIndexAttr = trigger.getAttribute("data-lightbox-index");
                                        const startingIndex = startingIndexAttr ? Number.parseInt(startingIndexAttr, 10) : 0;
                                        const stackMeta = {
                                            type: trigger.getAttribute("data-lightbox-type") || "",
                                            captureId: trigger.getAttribute("data-stack-id") || "",
                                            previewZipUrl: trigger.getAttribute("data-stack-preview") || "",
                                            rawZipUrl: trigger.getAttribute("data-stack-raw") || "",
                                        };
                                        openLightbox(
                                            src,
                                            label,
                                            parsedImages,
                                            Number.isNaN(startingIndex) ? 0 : startingIndex,
                                            stackMeta,
                                        );
                                    });
                                });

                                if (closeLightboxButton) {
                                    closeLightboxButton.addEventListener("click", closeLightbox);
                                }
                                if (moreOptionsButton) {
                                    moreOptionsButton.addEventListener("click", () => {
                                        if (!currentLightboxImages.length) {
                                            return;
                                        }
                                        updateDownloadControls();
                                        optionsMenu?.classList.toggle("hidden");
                                    });
                                }
                                if (downloadPreviewButton) {
                                    downloadPreviewButton.addEventListener("click", () => downloadCurrentFrameAsset("preview"));
                                }
                                if (downloadRawButton) {
                                    downloadRawButton.addEventListener("click", () => downloadCurrentFrameAsset("raw"));
                                }
                                if (downloadPreviewZipButton) {
                                    downloadPreviewZipButton.addEventListener("click", () => downloadCurrentFrameAsset("preview-zip"));
                                }
                                if (downloadRawZipButton) {
                                    downloadRawZipButton.addEventListener("click", () => downloadCurrentFrameAsset("raw-zip"));
                                }
                                if (lightbox) {
                                    lightbox.addEventListener("click", (event) => {
                                        if (event.target === lightbox) {
                                            closeLightbox();
                                        }
                                    });
                                }
                                document.addEventListener("click", (event) => {
                                    if (!optionsMenu || optionsMenu.classList.contains("hidden")) {
                                        return;
                                    }
                                    if (optionsMenu.contains(event.target) || (moreOptionsButton && moreOptionsButton.contains(event.target))) {
                                        return;
                                    }
                                    hideOptionsMenu();
                                });
                                document.addEventListener("keydown", (event) => {
                                    if (event.key !== "Escape") {
                                        return;
                                    }
                                    if (optionsMenu && !optionsMenu.classList.contains("hidden")) {
                                        hideOptionsMenu();
                                        return;
                                    }
                                    if (!lightbox.classList.contains("hidden")) {
                                        closeLightbox();
                                    }
                                });
                                closeLightbox();
                            </script>
                    lightboxImage.classList.remove("mt-16");
                    lightboxCarouselTrack.innerHTML = "";
                    lightboxFrameCounter.textContent = "";
                    return;
                }

            lightboxCarousel.classList.remove("hidden");
            lightboxImage.classList.add("mt-16");
            lightboxCarouselTrack.innerHTML = "";
            lightboxFrameCounter.textContent = `${currentLightboxIndex + 1} / ${currentLightboxImages.length}`;

            currentLightboxImages.forEach((image, index) => {
                const thumbButton = document.createElement("button");
                thumbButton.type = "button";
                thumbButton.className = `relative h-20 w-28 flex-shrink-0 overflow-hidden rounded-xl border transition focus:outline-none ${index === currentLightboxIndex
                    ? "border-aurora shadow-glow"
                    : "border-white/10 hover:border-white/30"}`;
                thumbButton.setAttribute("aria-label", image.label || `Frame ${index + 1}`);

                const thumbImage = document.createElement("img");
                thumbImage.src = image.src;
                thumbImage.alt = image.label || `Frame ${index + 1}`;
                thumbImage.className = "h-full w-full object-cover";
                thumbButton.appendChild(thumbImage);

                if (index === currentLightboxIndex) {
                    const indicator = document.createElement("div");
                    indicator.className = "pointer-events-none absolute inset-0 bg-aurora/10 ring-1 ring-inset ring-aurora/30";
                    thumbButton.appendChild(indicator);
                }

                thumbButton.addEventListener("click", () => {
                    updateLightboxImage(index);
                    renderLightboxCarousel();
                });

                lightboxCarouselTrack.appendChild(thumbButton);
            });
        }

            function openLightbox(src, label, rawImages = [], startingIndex = 0) {
                const normalizedLabel = normalizeLabel(label);
                let preparedImages = prepareImages(rawImages, normalizedLabel);
                if (!preparedImages.length && src) {
                    preparedImages = [{ src, label: normalizedLabel }];
                }
                currentLightboxImages = preparedImages;
                if (!currentLightboxImages.length) {
                    return;
                }
                const initialIndex = Number.isNaN(startingIndex)
                    ? 0
                    : Math.max(0, Math.min(startingIndex, currentLightboxImages.length - 1));
                updateLightboxImage(initialIndex);
                renderLightboxCarousel();
                lightbox.classList.remove("hidden");
                document.body.classList.add("overflow-hidden");
            }

        function closeLightbox() {
            lightbox.classList.add("hidden");
            lightboxImage.src = "";
            document.body.classList.remove("overflow-hidden");
            lightboxCaption.textContent = "";
            currentLightboxImages = [];
            currentLightboxIndex = 0;
            lightboxCarouselTrack.innerHTML = "";
            lightboxCarousel.classList.add("hidden");
            lightboxFrameCounter.textContent = "";
            hideOptionsMenu();
        }

        document.querySelectorAll("[data-lightbox-trigger]").forEach((trigger) => {
            trigger.addEventListener("click", () => {
                const src = trigger.getAttribute("data-lightbox-src");
                const label = trigger.getAttribute("data-lightbox-label") || "";
                const imagesAttr = trigger.getAttribute("data-lightbox-images");
                let parsedImages = [];
                if (imagesAttr) {
                    try {
                        parsedImages = JSON.parse(imagesAttr);
                    } catch (error) {
                        console.warn("Unable to parse image payload for lightbox", error);
                    }
                }
                const startingIndexAttr = trigger.getAttribute("data-lightbox-index");
                const startingIndex = startingIndexAttr ? Number.parseInt(startingIndexAttr, 10) : 0;
                openLightbox(src, label, parsedImages, Number.isNaN(startingIndex) ? 0 : startingIndex);
            });
        });

        closeLightboxButton.addEventListener("click", closeLightbox);
            moreOptionsButton.addEventListener("click", () => {
            if (!currentLightboxImages.length) {
            return;
            }
            updateDownloadControls();
            optionsMenu.classList.toggle("hidden");
            });
            downloadPreviewButton.addEventListener("click", () => downloadCurrentFrameAsset("preview"));
            downloadRawButton.addEventListener("click", () => downloadCurrentFrameAsset("raw"));
        lightbox.addEventListener("click", (event) => {
            if (event.target === lightbox) {
                closeLightbox();
            }
        });
            document.addEventListener("click", (event) => {
            if (optionsMenu.classList.contains("hidden")) {
            return;
            }
            if (optionsMenu.contains(event.target) || moreOptionsButton.contains(event.target)) {
            return;
            }
            hideOptionsMenu();
            });
        document.addEventListener("keydown", (event) => {
            if (event.key !== "Escape") {
            return;
            }
            if (!optionsMenu.classList.contains("hidden")) {
            hideOptionsMenu();
            return;
            }
            if (!lightbox.classList.contains("hidden")) {
                closeLightbox();
            }
        });
        closeLightbox();
    </script>
</body>

</html>